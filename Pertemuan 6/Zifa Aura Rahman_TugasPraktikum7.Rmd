---
title: "Tugas Pertemuan 6"
output:
  html_document:
    css: sidebarcolor.css
    toc: true
    toc_float: true
    theme: cerulean
    highlight: tango
---


```{r setup, include=FALSE}
library(ggplot2)
library(MASS)
library(tseries)
library(tsibble)
library(readxl)
library(forecast)
library(TSA)
library(TTR)
library(aTSA)
library(graphics)
```

# Input Data
```{r}
data <- read_xlsx("/Users/mrkahar/Downloads/JKSE_Close_Weekly.xlsx")

data1 <- data[776:1033, ]
data1
```

# Split Data
## Data Training
```{r}
dtgab1 <- data1[1:206, ]
ts_train <- ts(dtgab1$Close)
mean(dtgab1$Close)
var(dtgab1$Close)
```


### Plot Time Series
```{r}
plot2 <- ggplot(dtgab1, aes(x = Date, y = Close)) +
  geom_line() +
  theme_bw() +
  xlab("Date") +
  ylab("Nilai")

plot2

```

Berdasarkan plot time series tersebut, terlihat bahwa data **tidak stasioner dalam rataan**, ditandai dengan adanya kecenderungan (tren) positif, tetapi **stasioner dalam ragam**, ditandai dengan adanya lebar pita pada plot yang cenderung sama.

### Plot ACF
```{r}
acf(dtgab1$Close)
```

Berdasarkan plot ACF, terlihat bahwa plot ACF pada data training menurun secara perlahan (tails off slowly) pada banyak lag yang mengindikasikan kuat bahwa data **tidak stasioner dalam rataan**.

### Uji ADF

H0 : Data tidak stasioner dalam rataan

H1 : Data stasioner dalam rataan

```{r}
adf.test(dtgab1$Close)
```

Berdasarkan uji ADF tersebut, didapat p-value sebesar 0.0256 yang lebih kecil dari taraf nyata 5% dan menandakan bahwa data **stasioner dalam rataan**. Hal ini **tidak sesuai** dengan hasil eksplorasi menggunakan plot time series dan plot ACF.

### Plot Box-Cox
```{r}
index <- seq(1:206)
bc = boxcox(dtgab1$Close+1~index, 
             lambda = seq(3,5,by=1))
```

```{r}
#Nilai Rounded Lambda
lambda <- bc$x[which.max(bc$y)]
lambda

# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

Hasil uji Box–Cox menunjukkan bahwa nilai λ optimum adalah 5 dengan interval kepercayaan 95% sebesar (4.394-5.000). Karena selang tersebut tidak memuat nilai λ = 1, maka dapat disimpulkan bahwa data **tidak stasioner dalam ragam** sehingga diperlukan penanganan.

### Differencing

Berdasarkan hasil eksplorasi plot time series dan ACF terindikasi kuat bahwa data tidak stasioner dalam rataan namun stasioner dalam ragam maka dari itu langkah pertama yang akan dilakukan adalah differencing pertama.

```{r}
diff1 <- diff(dtgab1$Close, differences = 1)

# Plot hasil differencing
ts.plot(dtgab1,
        main = "First-order Differencing",
        col = "blue", lwd = 2)
```

Berdasarkan plot di atas, masih terlihat adanya tren positif pada data hasil differencing pertama yang mengindikasikan **ketidakstasioneran dalam rataan.**

#### Uji ADF Setelah Differencing

H0 : Data tidak stasioner dalam rataan

H1 : Data stasioner dalam rataan
 
```{r}
tseries::adf.test(diff1)
```

Berdasarkan uji ADF tersebut, didapat p-value < 0.01 yang lebih kecil dari taraf nyata 5% dan menandakan bahwa data hasil differencing pertama sudah **stasioner dalam rataan.**


#### Plot Box-Cox Setelah Differencing
```{r}
index <- 1:length(diff1)
bcc = boxcox(diff1 - min(diff1) + 1~index, 
             lambda = seq(-1,5,by=1))
```

```{r}
#Nilai Rounded Lambda
lambdaa <- bcc$x[which.max(bcc$y)]
lambdaa

# Selang kepercayaan 95% untuk lambda
ci_lambdaa <- bcc$x[bc$y > max(bcc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lowerr <- min(ci_lambdaa)
ci_upperr <- max(ci_lambdaa)

c(Batas_Bawah = ci_lowerr, Batas_Atas = ci_upperr)
```

Hasil uji Box–Cox menunjukkan bahwa nilai λ optimum adalah 1.545 dengan interval kepercayaan 95% sebesar (-1 - 5). Karena selang tersebut memuat nilai λ = 1, maka dapat disimpulkan bahwa data hasil differencing pertama sudah **stasioner dalam ragam** sehingga tidak diperlukan penanganan lebih lanjut.


## Data Testing
```{r}
dtgab2 <- data1[207:258, ] 
ts_test  <- ts(dtgab2$Close)
mean(dtgab2$Close)
var(dtgab2$Close)
```

### Plot Time Series
```{r}
plot1 <- dtgab2 |>
  ggplot(aes(x = Date, y = Close)) +
  geom_line() +
  theme_bw() +
  xlab("Date") +
  ylab("Nilai")

plot1
```

Berdasarkan plot time series tersebut, terlihat bahwa data testing **tidak stasioner dalam rataan dan ragam**, ditandai dengan adanya trend pada data serta perbedaan lebar pita pada plot.

### Plot ACF
```{r}
acf(dtgab2$Close)
```

Berdasarkan plot ACF, terlihat bahwa plot ACF pada data testing menurun secara perlahan (tails off slowly) yang menandakan data **tidak stasioner dalam rataan.**

### Uji ADF

H0 : Data tidak stasioner dalam rataan

H1 : Data stasioner dalam rataan

```{r}
adf.test(dtgab2$Close)
```

Berdasarkan uji ADF tersebut, didapat p-value sebesar 0.9532 yang lebih besar dari taraf nyata 5% dan menandakan bahwa data **tidak stasioner dalam rataan**. Hal ini sesuai dengan hasil eksplorasi menggunakan plot time series dan plot ACF.

### Plot Box-Cox
```{r}
index <- 1:nrow(dtgab2)
bc2 = boxcox(dtgab2$Close+1~index, 
             lambda = seq(3,5,by=1))
```

```{r}
#Nilai Rounded Lambda
lambda <- bc2$x[which.max(bc2$y)]
lambda

# Selang kepercayaan 95% untuk lambda
ci_lambda2 <- bc2$x[bc2$y > max(bc2$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower2 <- min(ci_lambda2)
ci_upper2 <- max(ci_lambda2)

c(Batas_Bawah = ci_lower2, Batas_Atas = ci_upper2)
```

Hasil uji Box–Cox menunjukkan bahwa nilai λ optimum adalah 3 dengan interval kepercayaan 95% sebesar (3-5). Karena selang tersebut tidak memuat nilai λ = 1, maka dapat disimpulkan bahwa data testing **tidak stasioner dalam ragam**. Hal ini sesuai dengan hasil eksplorasi menggunakan plot time series.

# Spesifikasi Model
## Plot ACF
```{r}
acf(diff1, main="ACF", lag.max=15) 
```

Berdasarkan plot tersebut, terlihat bahwa plot ACF cenderung cuts off pada lag ke 6, sehingga jika plot PACF dianggap tails of, maka model tentatifnya adalah **ARIMA(0,1,6).**

## Plot PACF
```{r}
pacf(diff1, main="PACF", lag.max=15)
```

Berdasarkan plot tersebut, terlihat bahwa plot PACF cenderung cuts off pada lag ke 6, sehingga jika plot ACF dianggap tails of, maka model tentatifnya adalah **ARIMA(6,1,0).**

## Plot EACF
```{r}
eacf(diff1)
```

Berdasarkan plot EACF, dapat diambil beberapa model dengan melihat ujung segitiga yang terbentuk, antara lain **ARIMA(0,1,1), ARIMA(1,1,1), dan ARIMA(1,1,2).**

# Pendugaan Parameter
```{r}
model1=Arima(ts_train, order=c(0,1,6),method="ML")
summary(model1)
lmtest::coeftest(model1) 
```

```{r}
model2=Arima(ts_train, order=c(6,1,0),method="ML")
summary(model2)
lmtest::coeftest(model2) 
```

```{r}
model3=Arima(ts_train, order=c(0,1,1),method="ML")
summary(model3)
lmtest::coeftest(model3) 
```

```{r}
model4=Arima(ts_train, order=c(1,1,1),method="ML")
summary(model4)
lmtest::coeftest(model4) 
```

```{r}
model5=Arima(ts_train, order=c(1,1,2),method="ML")
summary(model5)
lmtest::coeftest(model5) 
```

```{r} 
hasil_model <- data.frame(
  Model = c("ARIMA(0,1,6)",
            "ARIMA(6,1,0)",
            "ARIMA(0,1,1)",
            "ARIMA(1,1,1)",
            "ARIMA(1,1,2)"),
  AIC = c(
    AIC(model1),
    AIC(model2),
    AIC(model3),
    AIC(model4),
    AIC(model5)
  ),
  BIC = c(
    BIC(model1),
    BIC(model2),
    BIC(model3),
    BIC(model4),
    BIC(model5)
  )
)

hasil_model
```

Berdasarkan hasil perbandingan, model ARIMA(0,1,1) memiliki nilai AIC dan BIC terkecil. Namun, karena seluruh parameter pada model ARIMA(1,1,1) terbukti signifikan dan perbedaan nilai AIC serta BIC antar model relatif kecil, maka model **ARIMA(1,1,1)** dipilih sebagai model yang lebih tepat.

# Analisis Sisaan
## Eksplorasi Sisaan
```{r}
sisaan <- model4$residuals

car::qqPlot(sisaan)
plot(c(1:length(sisaan)),sisaan)

acf(sisaan)
pacf(sisaan)
```

Berdasarkan plot kuantil-kuantil normal, terlihat bahwa titik-titik sisaan cenderung tidak mengikuti garis diagonal, sehingga dapat dikatakan **sisaan tidak sepenuhnya menyebar mendekati normal**. Plot sebaran sisaan juga menunjukkan lebar pita yang tidak seragam, menandakan bahwa **ragam sisaan bersifat heterogen.** Selain itu, pada plot ACF dan PACF sisaan model ARIMA(1,1,1) terlihat adanya nilai yang signifikan pada lag ke-11 dan 6, sehingga **sisaan belum sepenuhnya saling bebas.** Kondisi ini akan dikonfirmasi lebih lanjut melalui uji formal.

## Uji Formal

**H0: Sisaan menyebar normal**

**H1: Sisaan tidak menyebar normal**

```{r}
#1) Sisaan Menyebar Normal
ks.test(sisaan,"pnorm") 
```

Berdasarkan uji KS tersebut, didapat p-value sebesar < 2.2e-16 yang kurang dari taraf nyata 5% sehingga tolak H0 dan menandakan bahwa sisaan tidak menyebar normal. Hal ini sesuai dengan hasil eksplorasi menggunakan plot kuantil-kuantil normal.


**H0: Sisaan saling bebas**

**H1: Sisaan tidak saling bebas**

```{r}
#2) Sisaan saling bebas/tidak ada autokorelasi
Box.test(sisaan, type = "Ljung") 
```

Berdasarkan uji Ljung-Box tersebut, didapat p-value sebesar 0.9084 yang lebih besar dari taraf nyata 5% sehingga gagal tolak H0 dan menandakan bahwa sisaan saling bebas. Hal ini berbeda dengan eksplorasi dengan plot ACF dan PACF.


**H0: Ragam sisaan homogen**

**H1: Ragam sisaan tidak homogen**

```{r}
#3) Sisaan homogen
Box.test((sisaan)^2, type = "Ljung")
```

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat p-value sebesar 0.0177 yang kurang dari taraf nyata 5% sehingga tolak H0 dan menandakan bahwa ragam sisaan tidak homogen. Hal ini sesuai dengan hasil eksplorasi menggunakan plot sebaran sisaan. 


**H0: Nilai tengah sisaan sama dengan nol**

**H1: Nilai tengah sisaan tidak sama dengan nol**

```{r}
#4) Nilai tengah sisaan sama dengan nol
t.test(sisaan, mu = 0, conf.level = 0.95) 
```

Berdasarkan uji-ttersebut, didapat p-value sebesar 0.1087 yang lebih besar dari taraf nyata 5% sehingga gagal tolak H0 dan menandakan bahwa nilai tengah sisaan sama dengan nol. Hal ini berbeda dengan eksplorasi.


# Overfitting

Tahapan selanjutnya adalah overfitting dilakukan dengan menaikkan orde AR(p) dan MA(q) dari model ARIMA(1,1,1) Kandidat model overfitting adalah **ARIMA(2,1,1) dan ARIMA(1,1,2).**

```{r}
model1a=Arima(ts_train, order=c(2,1,1),method="ML")
summary(model1a)
lmtest::coeftest(model1a)
```

```{r}
model1b=Arima(ts_train, order=c(1,1,2),method="ML")
summary(model1b)
lmtest::coeftest(model1b)
```

```{r}
overfitting <- data.frame(
  Model = c("ARIMA(2,1,1)","ARIMA(1,1,1)", "ARIMA(1,1,2)"),
  AIC   = c(AIC(model1a),AIC(model4), AIC(model1b)),
  BIC   = c(BIC(model1a),BIC(model4), BIC(model1b))
)

overfitting
```

Berdasarkan hasil perbandingan, nilai AIC dan BIC terkecil dimiliki oleh model **ARIMA(1,1,1)** sehingga model tersebut ditetapkan sebagai model terbaik. Selanjutnya akan dilakukan peramalan dengan model terbaik.


# Peramalan
```{r}
ramalan <- forecast::forecast(model4, h = length(ts_test)) 
ramalan
```

```{r}
data.ramalan <- ramalan$mean
plot(ramalan)
```
```{r}
hasil <- as.numeric(ramalan$mean)

# Bandingkan aktual vs forecast
perbandingan <- cbind(
  Aktual   = ts_test,
  Forecast = hasil
)

perbandingan

# Hitung akurasi
akurasi_test <- accuracy(hasil, ts_test)
akurasi_test
```

```{r}
# Plot data aktual (gabungan train + test)
ts.plot(c(ts_train, ts_test), col = "black", lty = 1,
        xlab = "Waktu", ylab = "Nilai",
        main = "Perbandingan Data Aktual dan Hasil Forecast")

# Garis hasil forecast
lines((length(ts_train)+1):(length(ts_train)+length(hasil)), hasil,
      col = "blue", lty = 2, lwd = 2)

# Tambahkan legenda
legend("topleft",
       legend = c("Data Aktual", "Forecast"),
       col = c("black", "blue"),
       lty = c(1, 2),
       lwd = c(1, 2),
       bty = "n")

```

Berdasarkan hasil peramalan, nilai **MAPE sebesar 5,72%** menunjukkan bahwa model memiliki tingkat kesalahan yang relatif kecil dan mampu menghasilkan prediksi yang cukup akurat. Grafik juga memperlihatkan bahwa hasil forecast mengikuti arah pergerakan data aktual meskipun cenderung lebih stabil. Dengan demikian, model ARIMA(1,1,1) dapat dikatakan **cukup baik** dalam memprediksi pola data pada periode berikutnya.



















<div class="footer-info">
  Zifa Aura Rahman<br>
  G1401231010<br>
</div>

